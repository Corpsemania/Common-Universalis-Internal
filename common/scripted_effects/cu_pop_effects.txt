### Public ###
#Population of a province is stored as p_pop, where 1 unit means 1k population
#Without modifiers, 20k population equals 1 development, but further modifiers can greatly increase development per pop

#Country Scope - Calculate countrywide population agriculture capacity modifier
cu_calc_pop_acm_c = {
	set_variable = { which = pop_acm value = 0.9 }
	if = {
		limit = { adm_tech = 32 }
		change_variable = { which = pop_acm value = 0.6 }
	}
	else_if = {
		limit = { adm_tech = 28 }
		change_variable = { which = pop_acm value = 0.5 }
	}
	else_if = {
		limit = { adm_tech = 25 }
		change_variable = { which = pop_acm value = 0.45 }
	}
	else_if = {
		limit = { adm_tech = 23 }
		change_variable = { which = pop_acm value = 0.4 }
	}
	else_if = {
		limit = { adm_tech = 21 }
		change_variable = { which = pop_acm value = 0.35 }
	}
	else_if = {
		limit = { adm_tech = 19 }
		change_variable = { which = pop_acm value = 0.3 }
	}
	else_if = {
		limit = { adm_tech = 17 }
		change_variable = { which = pop_acm value = 0.25 }
	}
	else_if = {
		limit = { adm_tech = 13 }
		change_variable = { which = pop_acm value = 0.2 }
	}
	else_if = {
		limit = { adm_tech = 9 }
		change_variable = { which = pop_acm value = 0.15 }
	}
	else_if = {
		limit = { adm_tech = 3 }
		change_variable = { which = pop_acm value = 0.1 }
	}
	every_owned_province = {
		cu_calc_pop_acm = yes
	}
}

#Province Scope - Calculate population agriculture capacity modifier
cu_calc_pop_acm = {
	set_variable = { which = pop_acm which = owner }
	
	#Modifier Sector
	
					#Terrain and Climate
					if = {
					        limit = {
						            has_terrain = farmlands
						    } 
					        change_variable = { which = pop_acm value = 0.05 }
					}
					else_if = {
					        limit = {
						            has_terrain = grasslands
						    } 
							if = { 
							      limit = { has_province_modifier = ti_irragation_done }
							      change_variable = { which = pop_acm value = 0.05 }
							}
					}
					else_if = {
					        limit = {
						            has_terrain = woods
						    } 
					        change_variable = { which = pop_acm value = -0.03 }
							if = { 
							        limit = { has_province_modifier = ti_woods_done }
									change_variable = { which = pop_acm value = 0.07 }
							}
					}
					
					else_if = {
					        limit = {
						            has_terrain = forest
						    } 
					        change_variable = { which = pop_acm value = -0.05 }
							if = { 
							        limit = { has_province_modifier = ti_forest_done }
							        change_variable = { which = pop_acm value = 0.07 }
							}
					}
					else_if = {
					        limit = {
						            has_terrain = hills
						    } 
					        change_variable = { which = pop_acm value = -0.08 }
							if = { 
							      limit = { has_province_modifier = ti_terrace_done }
							      change_variable = { which = pop_acm value = 0.10 }
							}
					}
					else_if = {
					        limit = {
						            has_terrain = coastline
						    } 
					        change_variable = { which = pop_acm value = -0.05 }
							if = { 
							      limit = { has_province_modifier = ti_irragation_done }
							      change_variable = { which = pop_acm value = 0.08 }
							}
					}
					else_if = {
					        limit = {
						            has_terrain = drylands
						    } 
					        change_variable = { which = pop_acm value = -0.15 }
							if = { 
							      limit = { has_province_modifier = ti_irragation_done }
							      change_variable = { which = pop_acm value = 0.15 }
							}
					}
					else_if = {
					        limit = {
						            has_terrain = highlands
						    } 
					        change_variable = { which = pop_acm value = -0.15 }
							if = { 
							      limit = { has_province_modifier = ti_irragation_done }
							      change_variable = { which = pop_acm value = 0.1 }
							}
					}
					else_if = {
					        limit = {
						            has_terrain = savannah
						    } 
					        change_variable = { which = pop_acm value = -0.1 }
							if = { 
							      limit = { has_province_modifier = ti_irragation_done }
							      change_variable = { which = pop_acm value = 0.1 }
							}
					}
					else_if = {
					        limit = {
						            has_terrain = jungle
						    } 
					        change_variable = { which = pop_acm value = -0.1 }
							if = { 
							      limit = { has_province_modifier = ti_jungle_done }
							      change_variable = { which = pop_acm value = 0.1 }
							}
					}
					
					else_if = {
					        limit = {
						            has_terrain = desert
						    } 
					        change_variable = { which = pop_acm value = -0.2 }
							if = { 
							      limit = { has_province_modifier = ti_irragation_done }
							      change_variable = { which = pop_acm value = 0.1 }
							}
					}
					
					else_if = {
					        limit = {
						            has_terrain = coastal_desert
						    } 
					        change_variable = { which = pop_acm value = -0.2 }
							if = { 
							      limit = { has_province_modifier = ti_irragation_done }
							      change_variable = { which = pop_acm value = 0.1 }
							}
					}
					
					else_if = {
					        limit = {
						            has_terrain = steppe
						    } 
					        change_variable = { which = pop_acm value = -0.1 }
							if = { 
							      limit = { has_province_modifier = ti_irragation_done }
							      change_variable = { which = pop_acm value = 0.1 }
							}
					}
					
					
					
					else_if = {
					        limit = {
						            has_terrain = mountain
						    } 
					        change_variable = { which = pop_acm value = -0.2 }
							if = { 
							      limit = { has_province_modifier = ti_terrace_done }
							      change_variable = { which = pop_acm value = 0.15 }
							}
					}
					
					else_if = {
					        limit = {
						            has_terrain = glacier
						    } 
					        change_variable = { which = pop_acm value = -0.3 }
					}
					
					else_if = {
					        limit = {
						            has_terrain = impassable_mountains
						    } 
					        change_variable = { which = pop_acm value = -0.3 }
					}
					
					
					
					else_if = {
					        limit = {
						            has_terrain = marsh
						    } 
					        change_variable = { which = pop_acm value = -0.15 }
							if = { 
							        limit = { 
									          OR = {
											        has_province_modifier = ti_marsh_done
       												has_province_modifier = holland_polders	  
											  }
									}
							        change_variable = { which = pop_acm value = 0.15 }
							}
					}
					#Goods
					if = {
					        limit = {
						            trade_goods = grain
						    } 
					        change_variable = { which = pop_acm value = 0.05 }
					}
					
					else_if = {
					        limit = {
						            trade_goods = fish
						    } 
					        change_variable = { which = pop_acm value = 0.05 }
					}
					
					
					
					#Climate
					if = {
					        limit = {
							       has_climate = arctic
							}
					        change_variable = { which = pop_acm value = -0.15 }
					}
					else_if = {
					        limit = {
							       has_climate = tropical
							}
					        change_variable = { which = pop_acm value = -0.1 }
					}
					if = {
					        limit = {
							       has_climate = arid
							}
					        change_variable = { which = pop_acm value = -0.1 }
							if = { 
							      limit = { has_province_modifier = ti_irragation_done }
							      change_variable = { which = pop_acm value = 0.1 }
							}
					}
					if = {
					        limit = {
							       owner = { has_country_modifier = ice_age }
							}
					        change_variable = { which = pop_acm value = -0.1 }
					}
					if = {
					        limit = {
							       new_world_i = 100
							}
					        change_variable = { which = pop_acm value = 0.05 }
					}
					#Terrain and Climate End
	
					#Buildings
					if = {
					        limit = {
							       has_building = mill
							}
					        change_variable = { which = pop_acm value = 0.1 }
							
					}
					else_if = {
					        limit = {
							       has_building = farm_estate
							}
							change_variable = { which = pop_acm value = 0.2 }
							
					}
	
					#Buildings End

	
					#Other Modifiers
					if = {
					      limit = { has_state_edict = edict_agriculture_focus }
						  change_variable = { which = pop_acm value = 0.05 }
					}
					
					if = {
					        limit = {
							      has_global_flag = ice_age_grain_price
							}
							change_variable = { which = pop_acm value = -0.05 }
					}
					
					#Other Modifiers End
	#Sector End
	
	if = {
		limit = { NOT = { check_variable = { which = pop_acm value = 0.1 } } }
		set_variable = { which = pop_acm value = 0.1 }
	}
	
}

#Game Scope - Set historical population data
cu_set_historical_pop = {
	1816 = { #Beijing, around 700k population
		set_variable = { which = p_pop value = 700 }
		set_province_flag = cu_historical_p_data
	}
}

#Province Scope - Initialize province population data, do "cu_calc_pop_acm_c = yes" before using this
cu_initialize_pop = {
	if = {
		limit = { is_empty = yes }
		set_variable = { which = p_pop value = 0 } #Wasteland
		set_province_flag = cu_p_pop_initialized
	}
	else_if = {
		limit = { has_province_flag = cu_historical_p_data } #Population is already set by historical data, no need to initialize
		set_province_flag = cu_p_pop_initialized
	}
	else = { #No historical data, set population from province development
		set_variable = { which = p_pop value = 1 } #Minimal population of each province is 1k
		
		#Agriculture Population
		export_to_variable = {
			which = cu_var1
			value = base_manpower
		}
		subtract_variable = { which = cu_var1 value = 1 } #The first development of each type is free, due to limitation of game engine.
		multiply_variable = { which = cu_var1 value = 20 }
		divide_variable = { which = cu_var1 which = pop_acm }
		change_variable = { which = p_pop which = cu_var1 }
	}
	
}